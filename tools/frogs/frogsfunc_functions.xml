<?xml version="1.0"?>
<!--
# Copyright (C) 2022 INRAE
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->
<tool id="FROGSFUNC_step3_functions" name="FROGSFUNC_step3_functions" version= "@TOOL_VERSION@+galaxy@VERSION_SUFFIX@">
    <description>Calculates functions abundances in each sample lo.</description>

  <macros>
        <import>macros.xml</import>
  </macros>

  <expand macro="requirements_frogsfunc" />


    <stdio>
        <exit_code range="1:" />
        <exit_code range=":-1" />
    </stdio>
    <command >
       frogsfunc_functions.py
            --input-biom $input_biom
            --input-fasta $input_fasta
            --input-tree $input_tree
            --input-marker $input_marker
            --marker-type $category.value
            #if $category.value == "16S"
                --functions $functions
            #end if
            #if $category.value != "16S"
                --input-function-table $functions.fields.traits
            #end if 
            --max-nsti $max_nsti
            --min-blast-ident $min_blast_ident
            --min-blast-cov $min_blast_cov
	   		--hsp-method $hsp_method
            --output-biom $output_biom
            --output-fasta $output_fasta
            --output-function-abund $output_function_abund
            --output-otu-norm $output_otu_norm
            --output-weighted $output_weighted
            --output-excluded $output_excluded
            --summary $summary_file

    </command> 
    <inputs>
        <!-- Input files -->
        <param argument="--input-biom" format="biom1" name="input_biom" type="data" label="Biom file" help="The abundance file i.e. FROGSFUNC_step1_placeseqs tool output file (frogsfunc_placeseqs.biom)." optional="false"/>
       	<param argument="--input-fasta" format="fasta" name="input_fasta" type="data" label="Sequence file" help="The fasta file i.e. from FROGSFUNC_step1_placeseqs tool output file (frogsfunc_placeseqs.fasta)." optional="false"/>
        <param argument="--input-tree" format="nhx" name="input_tree" type="data" label="Tree file" help="The file contains the tree information from FROGSFUNC_step1_placeseqs tool (frogsfunc_placeseqs_tree.nwk)." optional="false"/>
        <param argument='--input-marker' name="input_marker" format="tsv" type="data" label="Marker file" help="Table of predicted marker copy number i.e. FROGSFUNC_step1_placeseqs output (frogsfunc_marker.tsv)." optional="false"/>
        
        <!-- Parameters-->
	    <param name="category" type="select" label="Taxonomic marker" help="Taxonomic marker of interest." multiple="false" display="radio">
            <options from_data_table="frogs_picrust2_marker_table">
                <column name='name' index='0' />
                <column name='value' index='0' />
                <filter type="unique_value" column='0'/>
                    <validator type="no_options" message="A built-in database is not available" />
            </options>
		</param>
		<param argument='--functions' name="functions" type="select" label="Function table" multiple="true" optional="false" help=" 16S : at least 'EC' or/and 'KO' should be chosen (EC for Metacyc pathway analysis or/and KO for KEGG pathway analysis) - others values are optionnal. ITS and 18S : 'EC' only available." >
			<options from_data_table="frogs_picrust2_marker_table">
				<column name='name' index='1' />
				<column name='value' index='1' />
				<column name='path' index='2' />
				<column name='traits' index='3' />
                <filter type="param_value" ref="category" column="0" />   
 		<validator type="expression" message="'EC' is the default database used by PICRUSt2. 'EC' or 'KO' must be at least selected. Other tables are optionnal">"EC" in value or "KO" in value</validator>               
            </options>
        </param>
        <param argument="--max-nsti" name="max_nsti" type="float" label="NSTI cut-off" help="Any sequence with an NSTI above this threshold will be out. (default: 2)" value="2" min="0" optional="false" />
        <param argument="--min-blast-ident" name="min_blast_ident" type="float" label="Blast identity cut-off" help="Any sequence with a blast percentage identity against the PICRUSt2 closest ref above this value will will be out. (default: None)" value="0" min="0" max="1" optional="true" />
        <param argument="--min-blast-cov" name="min_blast_cov" type="float" label="Blast coverage cut-off" help="Any sequence with a blast coverage identity against the PICRUSt2 closest ref above this value will will be out. (default: None)" value="0" min="0" max="1" optional="true" />
		<param argument="--hsp-method" name="hsp_method" type="select" label="HSP method" help='Hidden-state prediction method to use: maximum parsimony (mp), empirical probabilities (emp_prob), continuous traits prediction using subtree averaging (subtree_average), continuous traits prediction with phylogentic independent contrast (pic), continuous traits reconstruction using squared-change parsimony (scp) (default: mp).' multiple="false" display="radio">
            <option value="mp">mp</option>
            <option value="emp_prob">emp_prob</option>
            <option value="pic">pic</option>
            <option value="scp">scp</option>
            <option value="subtree_average">subtree_average</option>
		</param> 
    </inputs>
    <outputs>
        <data format="html" name="summary_file" label="${tool.name}: report.html" from_work_dir="report.html"/>
		<data format="biom1" name="output_biom" label="${tool.name}: frogsfunc_functions.biom" from_work_dir="frogsfunc_functions.biom"/>
		<data format="fasta" name="output_fasta" label="${tool.name}: frogsfunc_functions.fasta" from_work_dir="frogsfunc_functions.fasta"/>

        <data format="tsv" name="output_otu_norm" label="${tool.name}: frogsfunc_functions_marker_norm.tsv" from_work_dir="frogsfunc_functions_marker_norm.tsv.tsv"/> 
        <data format="tsv" name="output_weighted" label="${tool.name}: frogsfunc_functions_weighted_nsti.tsv" from_work_dir="frogsfunc_functions_weighted_nsti.tsv"/> 
        <data format="tsv" name="output_excluded" label="${tool.name}: frogsfunc_functions_excluded.tsv" from_work_dir="frogsfunc_functions_excluded.tsv"/>
        <data format="tsv" name="output_function_abund" label="${tool.name}:   frogsfunc_functions_unstrat.tsv" from_work_dir="frogsfunc_functions_unstrat.tsv"/> 
    </outputs>


    <tests>
        <test>
            <param name="input_biom" value="references/25-frogsfunc_placeseqs.biom" />
            <param name="function" value="references/26-frogsfunc_copynumbers_predicted_functions.tsv" />
            <param name="marker" value="references/26-frogsfunc_copynumbers_marker.tsv"/>
            <param name="max_nsti" value="2" />
            <param name="min_reads" value="1" />
            <param name="min_samples" value="1" />
            <param name="strat" value="false" />

            <output name="output_function_abund" file="references/27-frogsfunc_functions_unstrat.tsv" compare="diff" lines_diff="0" />
            <output name="output_otu_norm" file="references/27-frogsfunc_functions_marker_norm.tsv" compare="diff" lines_diff="0" />
            <output name="output_weighted" file="references/27-frogsfunc_functions_weighted_nsti.tsv" compare="diff" lines_diff="0" />
            <output name="summary_file" file="references/27-frogsfunc_functions_report.html" compare="diff" lines_diff="0" />
            <output name="output_excluded" file="references/27-frogsfunc_functions_excluded.txt" compare="diff" lines_diff="0" />
        </test>
    </tests>

     <help>

@HELP_LOGO@

.. class:: infomark page-header h2

What it does

Predicting of functions weighted by the relative abundance of ASVs in the community. Inferring the metagenomes of the communities with `PICRUSt2 &lt;https://github.com/picrust/picrust2&gt;`_.
There are two steps performed at this stage:

    (i) The read depth per ASV is divided by the predicted marker (16S/ITS/18S) copy numbers. This is performed to help control for variation in marker copy numbers across organisms, which can result in interpretation issues.
        For instance, imagine an organism with five identical copies of the 16S gene that is at the same absolute abundance as an organism with one 16S gene. The ASV corresponding to the first organism would erroneously be inferred to be at higher relative abundance simply because this organism had more copies of the 16S gene.
         
    (ii) The ASV read depths per sample (after normalizing by marker (16S/ITS/18S) copy number) are multiplied by the predicted function copy numbers per ASV.         


.. class:: infomark page-header h2

Inputs/Outputs


.. class:: h3

Inputs


**Biom file**:

 The ASVs biom file from FROGSFUNC_step1_placeseqs tool (format `biom1 &lt;http://biom-format.org/documentation/format_versions/biom-1.0.html&gt;`_). (frogsfunc_placeseqs.biom from frogsfunc_1_placeseqs)

**Sequence file**:

 The sequence file of inserted ASVs into PICRUST2 reference tree from (frogsfunc_placesesqs.fasta from frogsfunc_1_placeseqs).

**Tree file**:

 The phylogenetic tree output with insert sequences into the reference tree (format: newick) (frogsfunc_placesesqs_tree.nwk from frogsfunc_1_placeseqs).


**Marker file**:

Output table of predicted marker gene copy numbers per sequence. (frogsfunc_marker.tsv from frogsfunc_1_placeseqs)

.. class:: h3

Parameters

**Taxonomic marker**:

 Marker gene to be analyzed.

**Function table**:

Which default pre-calculated count table to use ?
- For 16S rRNA gene you can choose between: 'EC', 'KO', 'PFAM', 'COG', 'TIGRFAM', and/or 'PHENO'. You must select at least 'EC' or 'KO' because for next FROGSFUNC tools, the information from Metacyc (EC) or KEGG (KO) are requiered.
- For ITS and 18S markers, 'EC' is only available.

For more informations about the different databases:

 - EC : https://enzyme.expasy.org/
 - KO : https://www.genome.jp/kegg/ko.html
 - PFAM : http://pfam.xfam.org/
 - COG : https://www.ncbi.nlm.nih.gov/research/cog-project/
 - TIGRFAM : https://tigrfams.jcvi.org/cgi-bin/index.cgi
 - PHENO : https://phenodb.org/

**NSTI cut-off**:

 Nearest Sequenced Taxon Index (`NSTI &lt;https://www.nature.com/articles/nbt.2676&gt;`_) is the phylogenetic distance between the ASV and the nearest sequenced reference genome. This metric can be used to identify ASVs that are highly distant from all reference sequences (the predictions for these sequences are less reliable!). The higher the NSTI score, the less the affiliations are relevant. Any ASVs with a NSTI value higher than 2 are typically either from uncharacterized phyla or off-target sequences.

**Blast identity cut-off**:

 Sequences with blast percentage identity against the PICRUSt2 closest ref above this value will be excluded (between 0 and 1).

**Blast coverage cut-off**:
 
 Sequence with a blast coverage identity against the PICRUSt2 closest ref above this value will will be excluded. (between 0 and 1).

**HSP method**:

  Hidden-state prediction method to use.

         

.. class:: h3

Outputs


**Fasta file**:

 Sequence file without excluded ASVs (NSTI, blast perc identity or blast perc coverage thresholds). frogsfunc_functions.fasta)

**Biom file** 

 Biom file without excluded ASVs (NSTI, blast perc identity or blast perc coverage thresholds). frogsfunc_functions.biom)

**Abundance table** (frogsfunc_placeseqs.biom)

**Report file**: (report.html)

.. image:: FROGS_frogsfunc_functions_piechart.png
    :height: 500
    :width: 1352

ASVs are out if the NSTI associated is above the threshold.

.. image:: FROGS_frogsfunc_functions_table.png
    :height: 580
    :width: 1352
 

.. image:: FROGS_frogsfunc_functions_sunburst.png


Gene families/function from KEGG or Metacyc databases are classified according to 3 hierarchy levels. The graph shows the proportion of each level within the selected samples.

**Function abundance file**:
 
 It is the function abundance predictions of metagenome, per sample. (frogsfunc_functions_unstrat_DATABASENAME.tsv, for exemple: frogsfunc_functions_unstrat_EC.tsv)
 
 - Classification column: the hierarchy classification of the gene function. 
 - db_link column: the url on the link accession ID (*observation_name*) of the function. 
 - observation_name: Accession identifier
 - observation_sum: Total abundance of functions across all samples.
 - last columns: Abundances of these functions in each samples.

**Excluded sequences**:

 Information (FROGS taxonomy, PICRUSt2 taxonomy, NSTI) about removed sequences that have a NSTI value aboved the NSTI threshold chosen in this step.

**Normalized ASV abundance table**:

 Table with normalized abundance per marker copy number. (frogsfunc_functions_marker_norm.tsv)

**Weighted NSTI file**:

 It is the table with average NSTI calculated per sample. (frogsfunc_functions_weighted_nsti.tsv)




@HELP_CONTACT@

    </help>


    <expand macro="citations" />
    
</tool>
